# babel介绍

## babel的用途

1. 代码转译到环境支持的js

用来把代码中的 `esnext` 的新的语法、`typescript` 和 `flow` 的语法转成基于目标环境支持的语法的实现。并且还可以把目标环境不支持的 `api` 进行 `polyfill`。

`babel7` 支持了 `preset-env`，可以指定 `targets` 来进行按需转换，转换更加的精准，产物更小。

2. 代码转换你想要的js

`babel` 是一个转译器，暴露了很多 `api`，用这些 `api` 可以完成代码到 `AST` 的解析、转换、以及目标代码的生成。

开发者可以用它来来完成一些特定用途的转换，比如函数插桩（函数中自动插入一些代码，例如埋点代码）、自动国际化等。

现在比较流行的小程序转译工具 `taro`，就是基于 `babel` 的 `api` 来实现的。

3. 代码静态分析

对代码进行 `parse` 之后，能够进行转换，是因为通过 `AST` 的结构能够理解代码。理解了代码之后，除了进行转换然后生成目标代码之外，也同样可以用于分析代码的信息，进行一些检查。

* `linter` 工具就是分析 `AST` 的结构，对代码规范进行检查。

* `api` 文档自动生成工具，可以提取源码中的注释，然后生成文档。

* `type checker` 会根据从 `AST` 中提取的或者推导的类型信息，对 `AST` 进行类型是否一致的检查，从而减少运行时因类型导致的错误。

* 压缩混淆工具，这个也是分析代码结构，进行删除死代码、变量名混淆、常量折叠等各种编译优化，生成体积更小、性能更优的代码。

* `js` 解释器，除了对 `AST` 进行各种信息的提取和检查以外，我们还可以直接解释执行 `AST`。

## 编译器与转译器

编译的定义就是从一种编程语言转成另一种编程语言. 一般编译器 `Compiler` 是指高级语言到低级语言的转换工具，对于高级语言到高级语言的转换工具，被叫做转换编译器，简称转译器 (`Transpiler`)。

`babel` 就是一个 `Javascript Transpiler`。

### babel的编译流程

`babel` 是 `source to source` 的转换，整体编译流程分为三步：

* `parse`：通过 `parser` 把源码转成抽象语法树（AST）
* `transform`：遍历 AST，调用各种 `transform` 插件对 AST 进行增删改
* `generate`：把转换后的 AST 打印成目标代码，并生成 `sourcemap`

### parse

parse 阶段的目的是把源码字符串转换成机器能够理解的 AST，这个过程分为**词法分析**、**语法分析**。

比如 `let name = 'guang';` 这样一段源码，我们要先把它分成一个个不能细分的单词（**token**），也就是 `let`, `name`, `=`, `'guang'`，这个过程是词法分析，按照单词的构成规则来拆分字符串成单词。

之后要把 token 进行递归的组装，生成 AST，这个过程是语法分析，按照不同的语法结构，来把一组单词组合成对象，比如声明语句、赋值表达式等都有对应的 AST 节点。

### transform

transform 阶段是对 parse 生成的 AST 的处理，会进行 AST 的遍历，遍历的过程中处理到不同的 AST 节点会调用注册的相应的 visitor 函数，visitor 函数里可以对 AST 节点进行增删改，返回新的 AST（可以指定是否继续遍历新生成的 AST）。这样遍历完一遍 AST 之后就完成了对代码的修改。

### generate

generate 阶段会把 AST 打印成目标代码字符串，并且会生成 sourcemap。不同的 AST 对应的不同结构的字符串。比如 `IfStatement` 就可以打印成 `if(test) {}` 格式的代码。这样从 AST 根节点进行递归的字符串拼接，就可以生成目标代码的字符串。

sourcemap 记录了源码到目标代码的转换关系，通过它我们可以找到目标代码中每一个节点对应的源码位置，用于调试的时候把编译后的代码映射回源码，或者线上报错的时候把报错位置映射到源码。